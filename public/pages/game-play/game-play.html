<!DOCTYPE html>
<html>
  <head>
    <title>Collect the coins!</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P"
      rel="stylesheet"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="/pages/game-play/game-play.css"
    />
    <link rel="stylesheet" type="text/css" href="/pages/global.css" />
  </head>
  <body>
    <div id="overlay"><h1>Loading ...</h1></div>

    <div id="game-over-overlay" style="display: none">
      <div id="game-over-content" style="width: 500px">
        <h1 style="text-align: center">
          Game Over

          <h2
            class="text-danger"
            style="text-align: center"
            id="game-over-text"
          ></h2>
        </h1>

        <div style="display: flex; gap: 5px; justify-content: space-between">
          <div>
            <h3>Player 1</h3>
            <h4>
              <span class="score-1">Score : _</span>
              <span class="text-muted>">/10</span>
            </h4>
          </div>
          <div>
            <h3>Player 2</h3>
            <h4>
              <span class="score-2">Score : _</span>
              <span class="text-muted">/10</span>
            </h4>
          </div>
        </div>

        <div>
          <!-- on click go back to /game-rooms -->
          <button
            id="quit-btn"
            class="primary-button"
            onclick="location.href='/game-rooms'"
          >
            Quit
          </button>
        </div>
      </div>
    </div>

    <div id="game-play-area">
      <div id="player-1-board" class="player-board">
        <h3 id="player-1">Player 1</h3>
        <h4>
          <span class="score-1">Score : 10 </span>
          <span class="text-muted">/10</span>
        </h4>
        <div>
          Skill :
          <span id="skill-1"><b class="text-success">Ready to use!</b></span>
        </div>
        <div class="description">
          <p class="cooldown-warning text-danger">Teleporter is on cooldown!</p>
          <p class="trap-status text-danger">Trapped!</p>
          <p class="coin-notification text-success">Coin collected (+1)</p>
          <p class="hit text-success">You have hit the enemy!</p>
          <p class="miss text-danger">You missed!</p>
          <p class="get-hit text-danger">You were hit by the enemy!</p>
        </div>
      </div>
      <div id="game-container">
        <canvas width="864px" height="648px"></canvas>

        <svg xmlns="http://www.w3.org/2000/svg" id="counter">
          <text x="10" y="35">
            TIME:
            <tspan id="time-remaining">3:00</tspan>
          </text>
        </svg>

        <svg
          xmlns="http://www.w3.org/2000/svg"
          id="game-over"
          style="display: none"
        >
          <defs>
            <linearGradient id="game-over-fill" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="red" />
              <stop offset="0.5" stop-color="yellow" />
              <stop offset="1" stop-color="red" />
            </linearGradient>
          </defs>
          <text x="50%" y="50%" id="game-over-text"></text>
          <text x="50%" y="75%" id="leave-button">Back to Game Room</text>
        </svg>
      </div>

      <div id="player-2-board" class="player-board">
        <h3 id="player-2">Player 2</h3>
        <h4>
          <span class="score-2">Score : 10 </span>
          <span class="text-muted">/10</span>
        </h4>
        <div>
          Skill :
          <span id="skill-2"><b class="text-success">Ready to use!</b></span>
        </div>
        <div class="description">
          <p class="cooldown-warning text-danger">Teleporter is on cooldown!</p>
          <p class="trap-status text-danger">Trapped!</p>
          <p class="coin-notification text-success">Coin collected (+1)</p>
          <p class="hit text-success">You have hit the enemy!</p>
          <p class="miss text-danger">You missed!</p>
          <p class="get-hit text-danger">You were hit by the enemy!</p>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"></script>
    <script src="scripts/socket.js"></script>
    <script src="scripts/game-play/bounding_box.js"></script>
    <script src="scripts/game-play/sprite.js"></script>
    <script src="scripts/authentication.js"></script>

    <!-- IMPORT CONSTANT -->
    <script src="scripts/game-play/constants/movement_sequences.js"></script>
    <script src="scripts/game-play/constants/attack_right_sequences.js"></script>
    <script src="scripts/game-play/constants/death_sequences.js"></script>

    <!-- helpers -->
    <script src="scripts/game-play/player/player_movements.js"></script>
    <script src="scripts/game-play/player/player_events.js"></script>
    <script src="scripts/game-play/player/keyboard_handler.js"></script>
    <script src="scripts/game-play/player/socket_movement_handler.js"></script>
    <!-- IMPORT GAME PLAY RELATED -->
    <script src="scripts/game-play/player.js"></script>
    <script src="scripts/game-play/coin.js"></script>
    <script src="scripts/game-play/platform.js"></script>
    <script src="scripts/game-play/floor.js"></script>
    <script src="scripts/game-play/transporter.js"></script>
    <script src="/socket.io/socket.io.min.js"></script>
    <script src="scripts/game-play/trap.js"></script>

    <script src="scripts/multiplayer/gameroom_config.js"></script>
    <script src="scripts/multiplayer/gameobjects_config.js"></script>
    <script src="scripts/ui/game-rooms.js"></script>
    <!-- util -->
    <script src="pages/game-play/util/notification.js"></script>
    <script src="pages/game-play/util/countdown.js"></script>

    <script>
      $(function () {
        let isGameEnd = false;
        let roomNum = null;
        let playerSlot = null;
        const maxScore = 10;
        const totalGameTime = 180; // Total game time in seconds
        let initComplete = false;
        Authentication.validate(
          () => {
            console.log("User is signed in.");
            Socket.connect();
            Socket.getGameConfig();
          },
          () => {
            console.log("User is not signed in.");
            alert("You are not signed in. Redirecting to sign in page...");
            window.location.href = "/";
          }
        );

        /* Get the canvas and 2D context */
        const cv = $("canvas").get(0);
        const context = cv.getContext("2d");

        //** All of this should be updated through websocket in do frame
        let gameStartTime = 0; // The timestamp when the game starts
        let collectedcoins = 0; // The number of coins collected in the game
        let transporterCooldown = 3500; // The cooldown for using the transporter
        let transporterTimeStamp = 0;
        const setTransporterTimeStamp = (time) => {
          transporterTimeStamp = time;
        };

        /* Create the game area */
        const gameArea = BoundingBox(context, -100, 0, 615, 864);
        const objectArea = BoundingBox(context, 8, 8, 580, 850);

        /* Create the sprites in the game */

        const floor = Floor(context, 0, 615);

        const coordinates = [
          { x: 74, y: 532 },
          { x: 28, y: 532 },
          { x: 33, y: 223 },
          { x: 33, y: 103 },
          { x: 178, y: 463 },
          { x: 178, y: 392 },
          { x: 178, y: 295 },
          { x: 178, y: 151 },
          { x: 321, y: 343 },
          { x: 321, y: 223 },
          { x: 321, y: 103 },
          { x: 465, y: 295 },
          { x: 465, y: 151 },
          { x: 682, y: 511 },
          { x: 682, y: 415 },
          { x: 682, y: 321 },
          { x: 682, y: 223 },
          { x: 753, y: 103 },
          { x: 608, y: 103 },
          { x: 58, y: 343 },
        ];

        const platforms = coordinates.map(
          (coord) => new Platform(context, coord.x, coord.y)
        ); // The platforms

        let colliders = new Array(platforms.length + 1).fill(false); // The colliders

        //Should decide position base on which player
        const player1 = Player(context, 100, 580, gameArea, 1); // The player
        const player2 = Player(context, 500, 580, gameArea, 2); // The player
        let playerInstance = null;
        let myScore = 0;
        let opponentScore = 0;

        //Coin coordinates should store in server
        const coin = Coin(context, -100, -100); // The coin

        let transporters = {
          1: Transporter(context, -5, -5),
          2: Transporter(context, -5, -5),
        };

        const trap = Trap(context, -5, -5); // The trap

        /* The main processing of the game */
        function doFrame(now) {
          if (!initComplete) {
            ({ roomNum, playerSlot } = GameroomConfig.getConfig());
            if (roomNum && playerSlot) {
              initComplete = true;
              $("#overlay").hide();

              // Set player instance based on playerSlot
              playerInstance = playerSlot === 2 ? player2 : player1;

              // Set board colors and player names based on playerSlot
              const isPlayer1 = playerSlot === 1;
              $("#player-1-board").css(
                "background-color",
                isPlayer1 ? "rgba(0, 0, 255, 0.8)" : "rgba(106, 0, 30, 1)"
              );
              $("h3#player-1").text(isPlayer1 ? "Me" : "Enemy");

              $("#player-2-board").css(
                "background-color",
                isPlayer1 ? "rgba(106, 0, 30, 1)" : "rgba(0, 0, 255, 0.8)"
              );
              $("h3#player-2").text(isPlayer1 ? "Enemy" : "Me");

              // start timer
              startCountdown();
            }
          }

          if (initComplete) {
            if (GameObjectsConfig.hasUpdate()) {
              let {
                gameStartTime,
                coinCoord,
                teleporterCoord,
                trapCoord,
                playerCoord,
                score,
              } = GameObjectsConfig.getConfig();

              coin.setXY(coinCoord.x, coinCoord.y);
              for (let i = 1; i <= 2; ++i) {
                transporters[i].setXY(
                  teleporterCoord[i].x,
                  teleporterCoord[i].y
                );
              }
              trap.setXY(trapCoord.x, trapCoord.y);
              player1.setXY(playerCoord[1].x, playerCoord[1].y);
              player2.setXY(playerCoord[2].x, playerCoord[2].y);

              const { score1, score2 } = score;
              $(".score-1").text("Score: " + score1);
              $(".score-2").text("Score: " + score2);
            }

            /* Update the sprites */
            coin.update(now);

            player1.update(now);
            player2.update(now);
            player1.udpateAttackRight(now);
            player2.udpateAttackRight(now);
            player1.udpateAttackLeft(now);
            player2.udpateAttackLeft(now);
            player1.updateTakeHit(now);
            player2.updateTakeHit(now);

            transporters[1].update(now);
            transporters[2].update(now);
            trap.update(now);
            playerInstance.updateSocketPlayerMovement(roomNum, playerSlot);

            const isCooldown = playerInstance.getIsAttackCooldown();
            const cooldownTxt = isCooldown ? "Cooling" : "Ready to use!";
            const $skill = $(`#skill-${playerSlot}`);

            $skill.text(cooldownTxt);
            $skill.toggleClass("text-danger", isCooldown);
            $skill.toggleClass("text-success", !isCooldown);

            handleGameEvents(
              player1,
              player2,
              coin,
              trap,
              transporters,
              platforms,
              floor,
              colliders,
              now,
              transporterTimeStamp,
              transporterCooldown,
              setTransporterTimeStamp
            );
            handleGameEvents(
              player2,
              player1,
              coin,
              trap,
              transporters,
              platforms,
              floor,
              colliders,
              now,
              transporterTimeStamp,
              transporterCooldown,
              setTransporterTimeStamp
            );

            /* Clear the screen */
            context.clearRect(0, 0, cv.width, cv.height);

            /* Draw the sprites */
            coin.draw();
            player1.draw();
            player2.draw();

            transporters[1].draw();
            transporters[2].draw();
            trap.draw();
          }

          requestAnimationFrame(doFrame);
        }

        function playerGravity(player, opponentPlayer, now) {
          //handle player right attack
          if (player.getIsAttacking()) {
            if (player.getAttackDirection() == "right") {
              if (
                Math.abs(
                  player.getAttackPosition().y - opponentPlayer.getXY().y
                ) < 15 &&
                // opponent is on the right within 50px
                opponentPlayer.getXY().x - player.getAttackPosition().x < 50 &&
                player.getAttackPosition().x - opponentPlayer.getXY().x < 0
              ) {
                opponentPlayer.takeHit();
                Notification(player.getPlayerSlot(), "hit");
                Notification(player.getPlayerSlot() == 1 ? 2 : 1, "get hit");
              }
            } else {
              console.log(player.getAttackDirection());
              console.log(
                opponentPlayer.getXY().x - player.getAttackPosition().x < 0
              );
              if (
                Math.abs(
                  player.getAttackPosition().y - opponentPlayer.getXY().y
                ) < 15 &&
                // opponent is on the left within 50px
                player.getAttackPosition().x - opponentPlayer.getXY().x > -50 &&
                opponentPlayer.getXY().x - player.getAttackPosition().x < 0
              ) {
                opponentPlayer.takeHit();
                Notification(player.getPlayerSlot(), "hit");
                Notification(player.getPlayerSlot() == 1 ? 2 : 1, "get hit");
              }
            }
          }

          //handle coin
          if (
            coin
              .getBoundingBox()
              .isPointInBox(player.getXY().x, player.getXY().y)
          ) {
            Notification(player.getPlayerSlot(), "coin");
            const { roomNum, playerSlot } = GameroomConfig.getConfig();
            console.log("Coin Coord=" + coin.getXY().x + coin.getXY().y);
            coin.setXY(-100, -100);
            Socket.playerCollectedCoin(roomNum, playerSlot);
          }

          //handle trap
          if (
            player
              .getBoundingBox()
              .isPointInBox(trap.getXY().x, trap.getXY().y - 15) &&
            !player.getInFall() &&
            !player.getInJump()
          ) {
            Notification(player.getPlayerSlot(), "trap");
            let boardId =
              player.getPlayerSlot() === 1
                ? "player-1-board"
                : "player-2-board";

            player.stop(1);
            player.trap(trap.getXY().x, trap.getXY().y - 25);
            // now reset trap position
            Socket.playerTrapped(roomNum, playerSlot);
            return;
          } else {
            // there is no trap near player
            let boardId =
              player.getPlayerSlot() === 1
                ? "player-1-board"
                : "player-2-board";

            player.setIsTrapped(false);
          }

          //handle transporter
          if (
            !player.getInFall() &&
            !player.getInJump() &&
            !player.getIsTrapped()
          ) {
            for (let i = 1; i <= 2; i++) {
              if (
                player
                  .getBoundingBox()
                  .isPointInBox(
                    transporters[i].getXY().x,
                    transporters[i].getXY().y - 30
                  )
              ) {
                if (now - transporterTimeStamp < transporterCooldown) {
                  Notification(player.getPlayerSlot(), "teleporter cooldown");
                } else {
                  console.log("Player is teleported");
                  transporterTimeStamp = now;
                  const transporter = transporters[i == 1 ? 2 : 1];
                  player.transport(
                    transporter.getXY().x,
                    transporter.getXY().y - 30,
                    now
                  );
                }

                // const { roomNum, playerSlot } = GameroomConfig.getConfig();
                // Socket.playerTeleported(roomNum, playerSlot, i);
              }
            }
          }

          //others
          for (let i = 0; i < colliders.length - 1; i++) {
            if (
              platforms[i]
                .getBoundingBox()
                .isPointInBox(player.getXY().x, player.getXY().y + 25)
            ) {
              colliders[i] = true;
            } else {
              colliders[i] = false;
            }
          }

          if (
            floor
              .getBoundingBox()
              .isPointInBox(player.getXY().x, player.getXY().y + 25)
          ) {
            colliders[colliders.length - 1] = true;
          } else {
            colliders[colliders.length - 1] = false;
          }

          if (player.getInFall() || !player.getInJump()) {
            if (colliders.some((value) => value === true)) {
              player.setInCollider(true);
            } else {
              player.setInCollider(false);
            }
          }
        }

        const endGame = function () {
          displayTxt = myScore > opponentScore ? "You Win!" : "You Lose...";
          $("#game-over").show();
          $("#game-over-text").text(displayTxt);
        };

        $(document).on("keydown", function (event) {
          handleKeydown(
            event,
            playerInstance,
            roomNum,
            playerSlot,
            initComplete
          );
        });

        /* Handle the keyup of arrow keys and spacebar */
        $(document).on("keyup", function (event) {
          handleKeyup(event, roomNum, playerSlot, playerInstance);
        });

        const playerEventSocket = io();
        if (playerEventSocket) {
          playerEventSocket.on("game keys event", (message) => {
            handlePlayerMovementSocket(player1, player2, message);
          });
        }

        $(document).on("click", function (event) {
          console.log("===========info============");
          console.log("I am Player: ", playerInstance.getPlayerSlot());
          const canvas = document.getElementById("game-container"); // replace 'your-canvas-id' with your actual canvas id

          const rect = canvas.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;

          console.log("x: " + x + " y: " + y);
          console.log("========end of info=========");
        });

        /* Start the game */
        requestAnimationFrame(doFrame);

        // for quiting game
        $("#quit-btn").on("click", function () {
          Socket.quitGame(roomNum, playerSlot);
        });
      });
    </script>
  </body>
</html>
